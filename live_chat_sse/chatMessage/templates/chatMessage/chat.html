<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat Bulle</title>
  <style>
    /* Styles g√©n√©raux pour les bulles de chat */
    .chat-bubble {
      position: fixed;
      bottom: 20px;
      width: 300px;
      max-height: 400px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      overflow: hidden;
      display: none; /* Initialement cach√© */
      flex-direction: column;
      z-index: 1000;
    }

    /* Styles sp√©cifiques pour les bulles de chat priv√©es */
    .chat-bubble.private-chat {
        border: 2px solid #28a745; /* Bordure verte distinctive */
        box-shadow: 0 4px 15px rgba(40,167,69,0.2); /* Ombre verte */
    }

    .chat-bubble.private-chat .chat-header {
        background: #28a745; /* En-t√™te vert pour les chats priv√©s */
    }

    .chat-header {
      background: #007bff;
      color: white;
      padding: 10px;
      font-weight: bold;
      cursor: pointer;
    }

    .chat-body {
      padding: 10px;
      overflow-y: auto;
      flex: 1;
      max-height: 250px;
    }

    .chat-input {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ccc;
    }

    .chat-input input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .chat-input button {
      margin-left: 8px;
      padding: 8px 12px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    .open-chat-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 24px;
      cursor: pointer;
      z-index: 999;
    }

    .chat-message {
      margin-bottom: 10px;
      padding: 6px 10px;
      background: #f1f1f1;
      border-radius: 8px;
    }

    /* Style pour le pseudo cliquable */
    .chat-sender {
        font-weight: bold;
        cursor: pointer;
        color: #007bff; /* Couleur pour indiquer la cliquabilit√© */
        text-decoration: underline;
    }
  </style>
</head>
<body>

<button class="open-chat-button" onclick="toggleChat('general')">üí¨</button>

<div class="chat-bubble" id="chatBubble-general">
  <div class="chat-header" onclick="toggleChat('general')">Chat G√©n√©ral</div>
  <div class="chat-body" id="chatLog-general"></div>
  <div class="chat-input">
    <input type="text" id="usernameInput-general" placeholder="Votre nom">
    <input type="hidden" id="groupNameInput-general" value="general">
  </div>
  <div class="chat-input">
    <input type="text" id="messageInput-general" placeholder="√âcris un message">
    <button onclick="sendMessage('general')">Envoyer</button>
  </div>
</div>

<script>
    const chatBubbles = {}; // Pour stocker les r√©f√©rences aux √©l√©ments DOM des bulles
    const webSockets = {}; // Pour stocker les connexions WebSocket pour chaque groupe

    // Fonction pour cr√©er une nouvelle bulle de chat
    function createChatBubble(groupName, isPrivate = false) {
        if (chatBubbles[groupName]) {
            // La bulle existe d√©j√†, il suffit de l'afficher
            toggleChat(groupName, true);
            return;
        }

        const chatContainer = document.createElement('div');
        chatContainer.classList.add('chat-bubble');
        chatContainer.id = `chatBubble-${groupName}`;

        if (isPrivate) {
            chatContainer.classList.add('private-chat');
            const numBubbles = Object.keys(chatBubbles).length;
            chatContainer.style.right = `${20 + (numBubbles * 320)}px`; // 320px = 300px (largeur) + 20px (marge)
        } else {
            chatContainer.style.right = '20px';
        }

        chatContainer.style.display = 'flex'; // Afficher la bulle nouvellement cr√©√©e

        const displayGroupName = isPrivate ?
            groupName.replace('private_', 'Priv√© ').replace(/_(\w+)$/, ' - $1') :
            groupName;

        chatContainer.innerHTML = `
            <div class="chat-header" onclick="toggleChat('${groupName}')">${displayGroupName}</div>
            <div class="chat-body" id="chatLog-${groupName}"></div>
            <div class="chat-input">
                <input type="text" id="usernameInput-${groupName}" placeholder="Votre nom">
                <input type="hidden" id="groupNameInput-${groupName}" value="${groupName}">
            </div>
            <div class="chat-input">
                <input type="text" id="messageInput-${groupName}" placeholder="√âcrire un message">
                <button onclick="sendMessage('${groupName}')">Envoyer</button>
            </div>
        `;
        document.body.appendChild(chatContainer);
        chatBubbles[groupName] = chatContainer;

        // Initialiser le WebSocket pour cette nouvelle bulle
        initWebSocket(groupName);

        // Pr√©-remplir l'entr√©e du nom d'utilisateur
        const currentUsername = document.getElementById('usernameInput-general').value;
        if (currentUsername) {
            document.getElementById(`usernameInput-${groupName}`).value = currentUsername;
        }

        // Faire d√©filer vers le bas
        const chatLog = document.getElementById(`chatLog-${groupName}`);
        if (chatLog) {
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    }

    // Fonction pour basculer la visibilit√© de la bulle de chat
    function toggleChat(groupName, forceDisplay = false) {
        const bubble = document.getElementById(`chatBubble-${groupName}`);
        if (bubble) {
            if (forceDisplay) {
                bubble.style.display = "flex";
            } else {
                bubble.style.display = (bubble.style.display === "none" || bubble.style.display === "") ? "flex" : "none";
            }
        }
    }

    // Fonction pour envoyer un message (utilisant toujours HTTP POST pour simplifier, Channels g√®re la diffusion)
    function sendMessage(groupName) {
        const usernameInput = document.getElementById(`usernameInput-${groupName}`);
        const messageInput = document.getElementById(`messageInput-${groupName}`);

        const username = usernameInput.value;
        const content = messageInput.value;

        if (!username || !content) {
            alert("Nom d'utilisateur et message requis !");
            return;
        }

        fetch("/chat/send/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ username: username, content: content, group_name: groupName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                messageInput.value = "";
            } else {
                console.error("Erreur d'envoi du message :", data.message);
            }
        })
        .catch(error => console.error("Erreur r√©seau lors de l'envoi du message :", error));
    }

    // Fonction pour initialiser le WebSocket pour un groupe donn√©
    function initWebSocket(groupName) {
        if (webSockets[groupName] && webSockets[groupName].readyState === WebSocket.OPEN) {
            return; // WebSocket d√©j√† ouvert
        }

        // D√©terminer le protocole WebSocket en fonction du protocole de la page actuelle
        const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const socket = new WebSocket(`${wsProtocol}${window.location.host}/ws/chat/${groupName}/`);

        socket.onopen = function(e) {
            console.log(`WebSocket ouvert pour le groupe : ${groupName}`);
        };

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const chatLog = document.getElementById(`chatLog-${groupName}`);

            if (chatLog) {
                const msg = document.createElement("div");
                msg.classList.add("chat-message");

                const senderSpan = document.createElement("span");
                senderSpan.classList.add("chat-sender");
                senderSpan.textContent = data.sender;
                senderSpan.dataset.senderId = data.sender_id;
                senderSpan.dataset.senderUsername = data.sender;

                const currentUsername = document.getElementById('usernameInput-general').value;
                if (currentUsername && data.sender !== currentUsername) {
                    senderSpan.onclick = () => promptPrivateChat(data.sender, data.sender_id);
                } else {
                    senderSpan.style.cursor = 'default';
                    senderSpan.style.textDecoration = 'none';
                    senderSpan.style.color = 'black';
                }

                msg.appendChild(document.createTextNode(`[${data.timestamp}] `));
                msg.appendChild(senderSpan);
                msg.appendChild(document.createTextNode(` : ${data.content}`));

                chatLog.appendChild(msg);
                chatLog.scrollTop = chatLog.scrollHeight;
            }
        };

        socket.onclose = function(e) {
            console.error(`WebSocket ferm√© de mani√®re inattendue pour le groupe ${groupName} :`, e);
            // Tentative de reconnexion apr√®s un d√©lai
            setTimeout(() => initWebSocket(groupName), 1000);
        };

        socket.onerror = function(err) {
            console.error(`Erreur WebSocket pour le groupe ${groupName} :`, err);
            socket.close(); // Fermer le socket pour d√©clencher onclose et une √©ventuelle reconnexion
        };

        webSockets[groupName] = socket;
    }

    // Fonction pour demander la cr√©ation d'un chat priv√©
    function promptPrivateChat(targetUsername, targetUserId) {
        const currentUsername = document.getElementById('usernameInput-general').value;
        if (!currentUsername) {
            alert("Veuillez entrer votre nom d'utilisateur avant de cr√©er un chat priv√©.");
            return;
        }
        if (currentUsername === targetUsername) {
            alert("Vous ne pouvez pas cr√©er un chat priv√© avec vous-m√™me.");
            return;
        }

        const confirmCreate = confirm(`Voulez-vous cr√©er un chat priv√© avec ${targetUsername} ?`);
        if (confirmCreate) {
            fetch("/chat/create_private_group/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: `current_username=${encodeURIComponent(currentUsername)}&target_username=${encodeURIComponent(targetUsername)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.group_name) {
                    createChatBubble(data.group_name, true); // Cr√©e la nouvelle bulle ou l'affiche si elle existe
                } else {
                    alert("Erreur lors de la cr√©ation du groupe priv√© : " + (data.error || ""));
                }
            })
            .catch(error => console.error("Erreur r√©seau lors de la cr√©ation du groupe priv√© :", error));
        }
    }

    // Initialiser la bulle de chat g√©n√©rale au chargement de la page
    document.addEventListener("DOMContentLoaded", () => {
        createChatBubble('general', false); // Cr√©e la bulle g√©n√©rale
        // S'assurer que le bouton g√©n√©ral ouvre la bulle g√©n√©rale
        document.querySelector('.open-chat-button').onclick = () => toggleChat('general');
    });

    // √âcouteur pour l'envoi de message avec 'Entr√©e'
    document.addEventListener('keydown', function(event) {
        if (event.target.id.startsWith('messageInput-') && event.key === "Enter") {
            const groupName = event.target.id.replace('messageInput-', '');
            sendMessage(groupName);
        }
    });
</script>

</body>
</html>
